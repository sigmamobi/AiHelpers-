# Пошаговая инструкция по сборке Android APK для тестирования

Это руководство поможет вам собрать Android APK (Android Package Kit) для вашего приложения AI Assistant. Мы рассмотрим два основных способа: облачную сборку через EAS Build (рекомендуется для проектов Expo) и локальную сборку с помощью Gradle (требует более глубокой настройки окружения).

APK, собранный таким образом, предназначен для тестирования и не требует сложной настройки ключей подписи, как для публикации в Google Play Store.

## Предварительные требования

Перед тем как начать, убедитесь, что у вас установлены и настроены следующие инструменты:

1.  **Node.js и npm**: Необходимы для работы с Expo и EAS CLI. (У вас уже установлены)
2.  **Expo CLI**: Глобально установленный Expo CLI. (У вас уже установлен: `npm install -g expo-cli`)
3.  **EAS CLI**: Глобально установленный EAS CLI. (У вас уже установлен: `npm install -g eas-cli`, и вы успешно авторизовались через `npx eas login`)
4.  **Git**: Для управления версиями и взаимодействия с EAS.
5.  **Java Development Kit (JDK)** (Только для локальной сборки через Gradle):
    *   Рекомендуемая версия: OpenJDK 17 (или 11).
    *   Подробные инструкции по установке см. в файле `install-jdk-instructions.md` (создан ранее).
6.  **Android Studio и Android SDK** (Только для локальной сборки через Gradle):
    *   Установите Android Studio с официального сайта. Вместе с ним установится Android SDK.
    *   Убедитесь, что переменная окружения `ANDROID_HOME` (или `ANDROID_SDK_ROOT`) правильно указывает на директорию вашего SDK. Инструкции также есть в `install-jdk-instructions.md`.

## Шаг 1: Проверка и подготовка конфигурации проекта

Убедитесь, что конфигурационные файлы вашего проекта (`app.json`, `app.config.js`, `eas.json`) настроены корректно.

### 1.1. `app.json` и `app.config.js`:
   *   **`slug`**: Должен быть "ai-assistant-app".
   *   **`owner`**: Должен быть ваш Expo username (например, "vyache").
   *   **`extra.eas.projectId`**: Должен быть корректный ID вашего проекта EAS (например, "e2a1cc11-58fd-4c53-9e95-d8b6bc04ea47").
   *   **`android.package`**: Уникальный идентификатор вашего приложения (например, "com.sigmamobi.aihelpers").
   *   **`version`**: Версия приложения (например, "1.0.0").
   *   **`android.versionCode`**: Целочисленная версия для Android (например, 1).

   Ваш `app.config.js` должен правильно загружать переменные окружения из `.env` для локальной разработки, но для EAS Build переменные должны быть настроены как EAS Secrets.

### 1.2. `eas.json`:
   Убедитесь, что у вас есть профиль для сборки тестового APK. Профили `local` или `preview` в вашем `eas.json` подходят для этого.

   Пример профиля **`local`** (идеально для тестовых APK):
   ```json
   // eas.json
   {
     "cli": {
       "version": ">= 7.6.0",
       "appVersionSource": "local"
     },
     "build": {
       "local": {
         "channel": "local",
         "distribution": "internal", // Для внутреннего распространения
         "android": {
           "buildType": "apk",
           "image": "latest", // Использует последний доступный образ сборки
           "gradleCommand": ":app:assembleDebug", // Собирает отладочный APK
           "withoutCredentials": true // Не требует ваших ключей подписи, EAS использует временные
         },
         "env": { // Переменные окружения для этой сборки
           "EXPO_PUBLIC_APP_ENV": "local"
           // Убедитесь, что все необходимые API ключи (SUPABASE_URL, SUPABASE_ANON_KEY, OPENAI_API_KEY, SERVICE_ROLE_KEY)
           // доступны здесь или, что более безопасно, установлены как EAS Secrets.
         }
       }
       // ... другие профили (development, preview, production) ...
     }
     // ...
   }
   ```
   *   **`withoutCredentials: true`**: Ключевой параметр для тестовых сборок, позволяет EAS подписывать APK временным ключом.
   *   **`gradleCommand: ":app:assembleDebug"`**: Собирает отладочную версию, которая обычно включает больше информации для отладки.

### 1.3. Устранение конфликтов зависимостей (ERESOLVE):
   Если при запуске команд `npm install` или во время сборки возникают ошибки `ERESOLVE`, это указывает на конфликты версий пакетов.
   *   **`npx expo doctor`**: Запустите эту команду для автоматической проверки и исправления распространенных проблем.
   *   **`npx expo install <package-name>`**: Используйте эту команду для установки пакетов, так как она выбирает совместимые версии.
   *   **`npm install --legacy-peer-deps`**: Временное решение, которое может помочь обойти конфликты.
   *   **Проверьте `package.json`**: Убедитесь, что версии `expo`, `react`, `react-native` и других ключевых зависимостей совместимы. Для вашего проекта с `expo@~50.0.17` должны быть соответствующие версии.

## Шаг 2: Сборка APK через EAS Build (Рекомендуемый способ)

EAS Build — это облачный сервис Expo, который упрощает сборку и подписание приложений.

1.  **Авторизация в EAS CLI** (вы уже успешно выполнили):
    ```bash
    npx eas login
    ```

2.  **Связка проекта с EAS** (если возникает ошибка "Invalid UUID appId"):
    *   Убедитесь, что `extra.eas.projectId` в `app.json` (или `app.config.js`) и `owner` указаны правильно.
    *   Если ошибка сохраняется, попробуйте переинициализировать проект в EAS:
        ```bash
        # Временно удалите или закомментируйте extra.eas.projectId из app.json/app.config.js
        npx eas project:init 
        ```
        Следуйте инструкциям, чтобы связать с существующим проектом по ID "e2a1cc11-58fd-4c53-9e95-d8b6bc04ea47".

3.  **Настройка EAS Secrets**:
    Переменные окружения, такие как API ключи, должны быть безопасно переданы в процесс сборки.
    ```bash
    # Перейдите в корневую директорию вашего проекта
    cd /Users/vyache/factoryai/clean-ai-app/ai-assistant

    # Создайте секреты (замените <value> на реальные значения из вашего .env файла)
    npx eas secret:create SUPABASE_URL --value "<ваше-supabase-url>"
    npx eas secret:create SUPABASE_ANON_KEY --value "<ваш-supabase-anon-key>"
    npx eas secret:create OPENAI_API_KEY --value "<ваш-openai-api-key>"
    npx eas secret:create SERVICE_ROLE_KEY --value "<ваш-supabase-service-role-key>" 
    # SERVICE_ROLE_KEY используется вашей Edge Function
    ```
    *Примечание: Если вы указали эти переменные в `eas.json` в секции `env` для профиля `local`, они будут использованы. Однако, для ключей API рекомендуется использовать EAS Secrets.*

4.  **Запуск сборки APK**:
    Используйте профиль `local` (или `preview`, если он настроен аналогично для APK без ваших credentials).
    ```bash
    npx eas build -p android --profile local
    ```
    *   `-p android`: Указывает платформу.
    *   `--profile local`: Указывает профиль сборки из `eas.json`.

5.  **Отслеживание процесса и загрузка APK**:
    *   EAS CLI предоставит ссылку на страницу сборки на сайте `expo.dev`.
    *   Сборка может занять 10-20 минут.
    *   После успешного завершения вы сможете скачать APK прямо со страницы сборки. Для сборок с `distribution: "internal"` также часто предоставляется QR-код.

## Шаг 3: Локальная сборка APK с помощью Gradle (Альтернатива, требует JDK и Android SDK)

Этот метод выполняется полностью на вашем компьютере.

1.  **Установка JDK и настройка ANDROID_HOME**:
    Убедитесь, что у вас установлены JDK (например, OpenJDK 17) и Android SDK, и переменные окружения `JAVA_HOME` и `ANDROID_HOME` настроены правильно. Подробные инструкции есть в файле `install-jdk-instructions.md`.

2.  **Генерация нативного Android-проекта**:
    Если папки `android` еще нет или вы хотите ее обновить:
    ```bash
    cd /Users/vyache/factoryai/clean-ai-app/ai-assistant
    npx expo prebuild --platform android --clean
    ```
    *   **Важно**: Убедитесь, что ваши файлы иконок и сплэш-экрана (`assets/icon.png`, `assets/splash.png`, `assets/adaptive-icon.png`) существуют и являются корректными изображениями, иначе `prebuild` может завершиться с ошибкой (например, "Could not find MIME for Buffer").

3.  **Переход в директорию `android`**:
    ```bash
    cd /Users/vyache/factoryai/clean-ai-app/ai-assistant/android
    ```

4.  **Очистка предыдущих сборок** (рекомендуется):
    ```bash
    ./gradlew clean
    ```
    *   Если возникает ошибка `Permission denied`, выполните `chmod +x ./gradlew`.

5.  **Сборка Debug APK**:
    ```bash
    ./gradlew assembleDebug
    ```
    Эта команда соберет отладочный APK, подписанный стандартным отладочным ключом.

6.  **Поиск APK**:
    После успешной сборки APK-файл будет находиться по пути:
    `android/app/build/outputs/apk/debug/app-debug.apk`

## Шаг 4: Установка APK на Android устройство или эмулятор

1.  **Разрешите установку из неизвестных источников** на вашем Android устройстве (Настройки → Безопасность или Приложения → Специальный доступ).
2.  **Перенесите APK-файл** на устройство (через USB, email, облако и т.д.).
3.  **Установите APK**, найдя его через файловый менеджер и тапнув по нему.
    Или используйте ADB (Android Debug Bridge), если он настроен:
    ```bash
    adb install /путь/к/вашему/app-debug.apk 
    ```

## Устранение распространенных проблем при сборке

*   **Ошибка "Gradle build failed with unknown error"**:
    *   **Проверьте логи сборки**: Если используете EAS Build, откройте ссылку на сборку на `expo.dev` и изучите логи фазы "Run gradlew". Если собираете локально, вывод в терминале будет содержать ошибки.
    *   **Проблемы с JDK/Android SDK**: Убедитесь, что они правильно установлены и настроены переменные окружения (`JAVA_HOME`, `ANDROID_HOME`).
    *   **Конфликты зависимостей**: Попробуйте `npx expo doctor --fix-dependencies` или вручную выровняйте версии в `package.json` под ваш SDK Expo.
    *   **Нехватка памяти**: Иногда сборка Gradle требует много памяти. Если сборка падает без явной ошибки, это может быть причиной.
*   **Ошибка "Cannot find module 'dotenv'" при `prebuild` или сборке**:
    *   Убедитесь, что `dotenv` установлен как зависимость в `package.json` (`npm install dotenv`).
    *   Ваш `app.config.js` должен корректно загружать переменные. Для EAS Build переменные должны быть установлены как EAS Secrets.
*   **Проблемы с нативными модулями**: Если вы добавили нативные модули, убедитесь, что они совместимы и правильно настроены для Android.

Следуя этим шагам, вы сможете собрать APK для тестирования. Рекомендуется начать с EAS Build, так как он обычно проще в настройке для проектов Expo. Если возникают проблемы, локальная сборка через Gradle дает больше контроля и возможностей для отладки.